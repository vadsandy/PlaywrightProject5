pipeline {
    agent { label 'UI-Agent' }

    parameters {
            gitParameter(
                name: 'SELECTED_FEATURE', 
                type: 'PT_FILE', 
                // Replace with your EXACT repo URL from the Screenshot
                useRepository: 'https://github.com/vadsandy/PlaywrightProject5.git',
                branch: '', // Leaving this blank forces it to look at the whole repo
                sortMode: 'ASCENDING_SMART',
                defaultValue: 'src/features/login.feature',
                description: 'Select the feature file to run'
            )

            choice(name: 'TAGS', choices: ['@UI', '@SMOKE', '@SQL', '@REGRESSION'])
            
            // Defaulting to Production
            choice(name: 'ENVIRONMENT', choices: ['Production', 'QA', 'Staging'])
            
            booleanParam(name: 'HEADLESS_MODE', defaultValue: false)
        }

    stages {
        stage('Cleanup & Install') {
            steps {
                // Clear old results to ensure a fresh report
                bat 'if exist allure-results rmdir /s /q allure-results'
                bat 'npm install'
            }
        }

        stage('Run Tests') {
            steps {
                withCredentials([
                    usernamePassword(credentialsId: 'db_credentials', 
                                    usernameVariable: 'DB_USER_VAL', 
                                    passwordVariable: 'DB_PASS_VAL')
                ]) {
                    script {
                        def headlessVal = params.HEADLESS_MODE ? "true" : "false"
                        
                        // Using single quotes for the password variable fix the interpolation warning
                        withEnv([
                            "HEADLESS=${headlessVal}", 
                            "TARGET_ENV=${params.ENVIRONMENT}",
                            "DB_USER=${DB_USER_VAL}", 
                            "DB_PASSWORD" : "${DB_PASS_VAL}" 
                        ]) {
                            echo "Running Feature: ${params.SELECTED_FEATURE}"
                            
                            // FIXED COMMAND: 
                            // 1. Added --require to explicitly point to your step definitions
                            // 2. Added --publish-quiet to clean up logs
                            bat """
                            npx cucumber-js "${params.SELECTED_FEATURE}" \
                            --require src/steps/**/*.js \
                            --tags "${params.TAGS}" \
                            --format progress \
                            --format allure-cucumberjs/reporter \
                            --publish-quiet
                            """
                        }
                    }
                }
            }
        }
    }
    
    post {
        always {
            allure results: [[path: 'allure-results']]
        }
    }
}