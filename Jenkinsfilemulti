pipeline {
    agent { label 'UI-Agent' }

    parameters {
        gitParameter(
            name: 'SELECTED_FEATURE', 
            type: 'PT_FILE', 
            sortMode: 'ASCENDING_SMART',
            defaultValue: 'src/features/login.feature',
            useRepository: 'https://github.com/vadsandy/PlaywrightProject5.git',
            branch: "${env.BRANCH_NAME}",
            pattern: 'src/features/.*\\.feature', 
            description: 'Select the feature file'
        )

        choice(
            name: 'TAGS', 
            choices: ['@UI', '@SMOKE', '@SQL', '@REGRESSION'], 
            description: 'Select test tags'
        )

        // Production is now first = Default
        choice(name: 'ENVIRONMENT', choices: ['Production', 'QA', 'Staging'])
        
        booleanParam(name: 'HEADLESS_MODE', defaultValue: false)
    }

    stages {
        stage('Cleanup & Setup') {
            steps {
                echo "Cleaning workspace and installing dependencies..."
                // Clean old results so Allure doesn't get confused
                bat 'if exist allure-results rmdir /s /q allure-results'
                bat 'mkdir allure-results'
                // Ensure cucumber-js is actually installed on the Agent
                bat 'npm install'
            }
        }

        stage('Run Tests') {
            steps {
                script {
                    def headlessVal = params.HEADLESS_MODE ? "true" : "false"

                    withEnv(["HEADLESS=${headlessVal}", "TARGET_ENV=${params.ENVIRONMENT}"]) {
                        echo "Executing branch ${env.BRANCH_NAME}: ${params.SELECTED_FEATURE}"
                        // Use the full path or call to ensure the local binary is used
                        bat "npx cucumber-js ${params.SELECTED_FEATURE} --tags \"${params.TAGS}\" --format progress --format allure-cucumberjs/reporter || exit 0"
                    }
                }
            }
        }
    }
    
    post {
        always {
            // This will now find real results generated by the local cucumber-js
            allure results: [[path: 'allure-results']]
        }
    }
}