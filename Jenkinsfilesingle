pipeline {
    agent { label 'UI-Agent' }

    parameters {
        choice(name: 'ENVIRONMENT', choices: ['Production', 'QA', 'Staging'], description: 'Target Test Environment')
        
        activeChoice(name: 'FEATURES', choiceType: 'PT_CHECKBOX', description: 'Select Features', 
            script: [
                $class: 'GroovyScript', 
                script: [
                    sandbox: false, 
                    script: """
                        def list = []
                        // We use 'HEAD' because it always refers to the branch Jenkins just checked out
                        def cmd = "git ls-tree -r --name-only HEAD src/features/"
                        try {
                            def proc = cmd.execute(null, new File("C:/JenkinsAgent/workspace/Playwright-Automation-Dev"))
                            proc.waitFor()
                            
                            def output = proc.in.text
                            output.eachLine { line ->
                                if (line.endsWith(".feature")) {
                                    list.add(line.split('/').last())
                                }
                            }
                        } catch (Exception e) {
                            return ["Error fetching features: " + e.message]
                        }
                        return list.sort() ?: ["No features found in src/features/"]
                    """
                ]
            ]
        )

        activeChoice(name: 'TAGS', choiceType: 'PT_CHECKBOX', description: 'Select Tags', 
            script: [
                $class: 'GroovyScript', 
                script: [sandbox: true, script: "return ['@UI', '@SMOKE', '@SQL', '@REGRESSION', '@JSON', '@Excel', '@fireup']"]
            ]
        )

        booleanParam(name: 'HEADLESS_MODE', defaultValue: false, description: 'Uncheck to see browser')
    }

    stages {
        stage('Cleanup') {
            steps {
                bat 'if exist allure-results del /q allure-results\\*'
                bat 'if exist reports rmdir /s /q reports && mkdir reports'
            }
        }

        stage('Install') {
            steps {
                bat 'npm install'
            }
        }

        stage('Execute Tests') {
            steps {
                withCredentials([
                    usernamePassword(credentialsId: 'db_credentials', usernameVariable: 'U_VAL', passwordVariable: 'P_VAL')
                ]) {
                    script {
                        // 1. Safe Parameter Handling: Use the Elvis operator (?:) 
                        // to provide a fallback if the parameter is null.
                        def rawSuite = params.TAGS ?: "@fireup"
                        def featurePath = params.FEATURES ? "src/features/${params.FEATURES}" : "src/features"
                        def headlessVal = params.HEADLESS_MODE ? "true" : "false"

                        // 2. Perform the replaceAll on the safe variable
                        def tagExpr = rawSuite.replaceAll('&#64;', '@').replaceAll(',', ' or ')

                        withEnv([
                            "HEADLESS=${headlessVal}",
                            "TARGET_ENV=${params.ENVIRONMENT ?: 'Production'}",
                            "DB_USER=${U_VAL}",
                            "DB_PASSWORD=${P_VAL}"
                        ]) {
                            echo "Executing: ${featurePath} with tags: ${tagExpr}"
                            
                            // 3. CRITICAL: Use Double Quotes (") for the whole string 
                            // so Jenkins replaces the ${variables} correctly.
                            bat "npx cucumber-js ${featurePath} --tags \"${tagExpr}\" --format progress --format allure-cucumberjs/reporter || exit 0"
                        }
                    }
                }
            }
        }
    }

    post {
        always {
            allure results: [[path: 'allure-results']]
        }
    }
}